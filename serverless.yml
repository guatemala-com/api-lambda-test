service: aprende-headless-api

frameworkVersion: '3'

# Jetpack es todo lo que necesitamos para la optimizaci√≥n
plugins:
  - serverless-jetpack

provider:
  name: aws
  runtime: nodejs20.x
  stage: ${env:STAGE, 'dev'}
  region: us-west-2
  iamRoleStatements:
    - Effect: Allow
      Action:
        - ec2:CreateNetworkInterface
        - ec2:DescribeNetworkInterfaces
        - ec2:DeleteNetworkInterface
      Resource: "*"
  vpc:
    securityGroupIds:
      - ${env:SECURITY_GROUP_ID}
    subnetIds:
       - ${env:SUBNET_1_ID}
       - ${env:SUBNET_2_ID}

  # authorizer api gateway + cognito
  httpApi:
    authorizers:
      cognitoAuthorizer:
        identitySource: $request.header.Authorization
        issuerUrl: https://cognito-idp.us-west-2.amazonaws.com/${env:COGNITO_USER_POOL_ID}
        audience:
          - ${env:COGNITO_APP_CLIENT_ID}

package:
  individually: true

functions:
  main:
    handler: dist/lambda.handler
    environment:
      DB_HOST: ${env:DB_HOST, 'localhost'}
      JWT_SECRET: ${env:JWT_SECRET, 'secret'}
    events:
      - httpApi:
          path: /{proxy+}
          method: '*'
          # authorizer api gateway + cognito
          authorizer:
            name: cognitoAuthorizer